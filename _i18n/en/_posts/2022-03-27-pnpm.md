---
layout: post
title: Get to know pnpm - a fast, disk-saving package manager
date: 2022-03-27 00:14:43
tags: [pnpm]
categories:
 - build-tool
---

# 0 Preface

Currently, the project is built using _npm_ or _yarn_. By getting to know _pnpm_, see if you can use _pnpm_ to replace the current package manager and improve the project construction speed.

<!-- more -->

# 1 What is pnpm

_pnpm_, that is, _performant npm_, high-performance npm. Compared with the current mainstream package managers, _pnpm_ is a package manager that is fast and saves disk space.

# 2 Performance comparison

The following is provided by the official website [Performance Comparison](https://www.pnpm.cn/benchmarks):
! [Performance comparison](/assets/img/2022/03/pnpm-speed-1.jpg)
! [Performance comparison](/assets/img/2022/03/pnpm-speed-2.jpg)

It can be seen that compared with the current mainstream package managers _npm_ and _yarn_, the installation speed of _pnpm_ has obvious advantages regardless of whether there is cache, lockfile or node_modules.

# 3 Save disk space and increase installation speed

Why is _pnpm_ so fast? The main reason is that _pnpm_ uses the **hard link (hard link)** mechanism to _save disk space and increase installation speed_.

> **hard link (hard link)**: Multiple file names point to the same index node (Inode). One of the functions of hard links is to allow a file to have multiple valid path names, so that users can establish hard links to important files to prevent " accidental deletion" of source data.

When using _npm_ or _Yarn_, if you have 100 projects, and all projects have the same dependency package, then you need to save 100 copies of the same package ( dependency package) on the hard disk.

With _pnpm_, the package will be stored in a unified location (such as Mac `~/.pnpm-store`). When a package is installed, all files it contains are hard-linked from this location, taking up no additional hard drive space. This allows you to easily This allows you to easily share the same version of a package between projects. Therefore, there will be no problem of repeatedly installing the same package mentioned above.
try `pnpm install`Install dependencies, you can see `reused`The same package that has been installed before.
The same package that has been installed before. [pnpm install](/assets/img/2022/03/pnpm-install.jpg)
When installing a software package with the same name with different versions, only the files that differ between versions will be added to the storage, and all files in the package will not be added to the storage. and all files in the package will not be saved due to the modification of one file.
At the same time, this command provides an option, the usage method is:`pnpm store prune`, which provides a function for deleting some packages that are not referenced by the global project. Developers can use this command to manage existing packages if necessary.

# 4 `node_modules` Directory optimization

In addition to saving disk space, another important feature of _pnpm_ is to create _non-flat_ `node_modules`directory, and find the corresponding one through the **sybolic link** mechanism when referencing dependencies.`.pnpm`The address of the directory. Why is this necessary?

## 4.1 `npm@2` Problems

For example, there is a package in the project `foo`,and `foo`There is another package `bar`, it will look like this: `npm@2`, _npm_`node_modules`Directories are non-flat. bar`, it will look like this: !
! [nested-install](/assets/img/2022/03/nested-install.jpg)

Such a nested installation will have the following problems.

* Packages often create dependency trees that are too deep, which can lead to long directory paths on Windows.
* When a package is required in different dependencies, it will be copied and pasted multiple times and multiple files will be generated, resulting in a large number of dependencies being installed repeatedly.

## 4.2 `npm@3+`Problems with _yarn_

So, in `npm@3+` and _yarn_, through flattening, solve the problem that dependencies cannot be shared and the dependency level is too deep. all dependencies are flattened in `node_modules`The first-level directory in . like.
! [flat-install](/assets/img/2022/03/flat-install-1.jpg)
However, only one of the multiple versions of the package (the one installed first) is promoted, and the other versions of the package will still be nested However, only one of the multiple versions of the package (the one installed first) is promoted, and the other versions of the package will still be nested and installed into their respective dependencies. The above-mentioned problems of too long paths and repeated installations have not been completely The above-mentioned problems of too long paths and repeated installations have not been completely solved.
The above-mentioned problems of too long paths and repeated installations have not been completely solved. [Flat install comparison](/assets/img/2022/03/flat-install-2.jpg)

Moreover, upgrading dependent packages will bring about a new problem: Phantom dependencies, that is, the upgraded package is not depended on in package .json, but users can reference this package.

## 4.3 _pnpm_ solution

Use _pnpm_ to install dependencies and open`node_modules`, we can see,`node_modules`The directory is _non-flat_ (unlike`npm@2`same), and at the same time there is one more`.pnpm`directory. and`node_modules`The dependent packages under are all **sybolic link (soft link)**. same time there is one more `.pnpm`directory. and `node_modules`The dependent packages under are all **sybolic link (soft link)** and `node_modules`The directory is _non-flat_ (unlike `npm@2`same, and at the same time there is one more `.pnpm`directory.
The dependent packages under are all **sybolic link (soft link)** ! [node-modules](/assets/img/2022/03/pnpm-node-modules-1.jpg)
Open `.pnpm`, you can see,`.pnpm`All packages are stored in flat format.`node_modules`All packages in the directory are soft linked to `.pnpm`Below the path:`.pnpm/<organization-name>+<package- name>@<version>/node_modules/<name>`.
! [node-modules](/assets/img/2022/03/pnpm-node-modules-2.jpg)

> **sybolic link (soft link, also called symbolic link)**: similar to the shortcut in the Windows system. Different from the hard link, the soft link is an ordinary file, but the content of the data block is a bit special. Different from the hard link, the soft link is an ordinary file, but the content of the data block is a bit special. The content stored in the file user data block is the path name of another file. The content stored in the file user data block is the path name of another file. In this way, the source file entity pointed to by the soft link can be quickly located.

In this way, _pnpm_ achieves isolation and reuse between different versions of the same module. and,`node_modules`Directories are _non-flat_ and There are no ghost dependency issues due to promotion.

# 5 Summary

_pnpm_ creates a global store directory for storage through **hard link** `node_modules`Depends on the **hard link** address inside. This saves disk space and speeds up installation. space and speeds up installation.
`node_modules`The directory is _non-flat_. When referencing dependencies, **sybolic link** is used to find the corresponding virtual disk directory (`.pnpm`directory) dependent address. In this way, a series of problems caused by previous _npm_ and _yarn_ flat/non-flat installations are avoided.
! [pnpm architecture](/assets/img/2022/03/pnpm-architecture.jpeg)

# 6 support monorepo

The original project also used _monorepo_. I wonder if _pnpm_ supports it? The answer is yes, you can check the official website for specific usage methods.[documentation](https://www.pnpm.cn/pnpm- The answer is yes, you can check the official website for specific usage methods.)

It seems that _pnpm_ can be used instead of the current package manager! Tried it,`pnpm install`The time consuming is the original `npm ci`60%, it is a The time consuming is the original `npm ci` 60%, it is a worthwhile try!

# 7 Reference

* [Motivation|pnpm](https://www.pnpm.cn/motivation)
* [Benchmarks of JavaScript Package Managers|pnpm](https://www.pnpm.cn/benchmarks)
* [It's 2022, pnpm come to the bowl!] (https://zhuanlan.zhihu.com/p/457698236)
